<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - View Bookings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"> <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="booking.css"> <!-- External CSS for Admin Styles -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- Admin Header -->
    <header class="bg-dark text-white py-3">
        <div class="container d-flex justify-content-between">
            <h1>Admin Dashboard</h1>
            <nav>
                <a href="admin.html" class="text-white me-3">View Bookings</a>
                <a href="booking.html" class="text-white">Logout</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mt-5">
        <h2 class="mb-4">User Bookings</h2>
        <!-- Custom Alert -->
<div id="customAlert" class="alert" style="display: none;">
    <span id="alertMessage"></span>
</div>

        <!-- Filter Dropdown for Booking Status -->
        <div class="mb-3">
            <label for="statusFilter" class="form-label">Filter by Status</label>
            <select id="statusFilter" class="form-select" onchange="fetchBookings()">
                <option value="">All</option>
                <option value="confirmed">Confirmed</option>
                <option value="pending">Pending</option>
                <option value="canceled">Canceled</option>
            </select>
        </div>

        <!-- Booking Table -->
        <table class="table table-striped" id="bookingTable">
            <thead>
                <tr>
                    <th scope="col">Booking ID</th>
                    <th scope="col">User Name</th>
                    <th scope="col">Email</th>
                    <th scope="col">Cell</th>
                    <th scope="col">Booking Date</th>
                    <th scope="col">Created At</th>
                    <th scope="col">Status</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be inserted here dynamically -->
            </tbody>
        </table>
        
        <!-- Pagination (if needed) -->
        <nav aria-label="Booking Navigation">
            <ul class="pagination">
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <!-- Modal to Shift Dates -->
        <!-- Modal to Shift Dates -->
<div id="shiftDateModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Shift Booking Dates</h2>
        
        <form id="shiftDateForm">
            <label for="newDate">New Date:</label>
            <input type="date" id="newDate" required>
            <label for="newTime">New Time:</label>
            <input type="time" id="newTime" required>
            <button type="submit" class="submit-btn">Save</button>
        </form>
    </div>
</div>
<div id="loading-spinner" style="display:none; position: fixed; top: 50%; left: 48%; transform: translate(-50%, -50%); z-index: 1001;">
</div>
    </div>

    <!-- Footer Section -->
    <footer class="bg-dark text-white py-2 mt-5">
        <div class="container text-center">
            <p>&copy; 2025 Braider's Booking Service. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <!-- JavaScript to fetch booking data -->
    <script>
        // Helper function to format the date to "14 July 2025"
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', options);  // 'en-GB' ensures "Day Month Year" format
        }
    
        // Function to update the booking status
        async function updateBookingStatus(bookingId, status) {
            try {
                const response = await fetch(`http://localhost:3000/update-booking-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: bookingId, status: status }),
                });
    
                if (!response.ok) {
                    throw new Error('Failed to update booking status');
                }
    
                alert(`Booking ${status === 'approved' ? 'Approved' : 'Declined'} successfully`);
                fetchBookings(); // Refresh the table
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating booking status');
            }
        }
    
        // Fetch booking data from the server with status filter
        async function fetchBookings() {
            try {
                const statusFilter = document.getElementById('statusFilter').value; // Get selected filter value
                const response = await fetch(`http://localhost:3000/get-bookings?status=${statusFilter}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
    
                const data = await response.json();
    
                if (Array.isArray(data)) {
                    const bookingsTableBody = document.querySelector('#bookingTable tbody');
                    bookingsTableBody.innerHTML = '';  // Clear any previous rows
    
                    // Loop through bookings and add them to the table
                    data.forEach(booking => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${booking.id}</td>
                            <td>${booking.name}</td>
                            <td>${booking.email}</td>
                            <td>${booking.cell}</td>
                            <td>${formatDate(booking.date)} ${booking.time}</td>
                            <td>${formatDate(booking.created_at)}</td>
                            <td>${booking.approved ? 'Confirmed' : 'Pending'}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="approveBooking(${booking.id})">Approve</button>
                                <button class="btn btn-warning btn-sm" onclick="showShiftDateModal(${booking.id})">Shift Dates</button>
                            </td>
                        `;
                        bookingsTableBody.appendChild(row);
                    });
                } else {
                    console.error('Invalid data format', data);
                    alert('Error fetching bookings: Invalid data format');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error fetching bookings');
            }
        }
    
        // Function to approve a booking
        async function approveBooking(bookingId) {
            try {
                const response = await fetch('http://localhost:3000/approve-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ bookingId }),  // Send the booking ID in the request body
                });
    
                if (!response.ok) {
                    throw new Error('Failed to approve booking');
                }
    
                alert('Booking successfully approved!');
                fetchBookings(); // Refresh the table after approving
            } catch (error) {
                console.error('Error:', error);
                alert('Error approving booking');
            }
        }
    
        let bookingToShift = null; // Variable to hold the booking ID that needs to be shifted

// Show the modal to shift dates
function showShiftDateModal(bookingId) {
    // Store the booking ID globally so we can use it when submitting the form
    window.bookingId = bookingId;

    // Show the modal
    $('#shiftDateModal').fadeIn(); // Fade in effect when opening the modal
}

function closeModal() {
    $('#shiftDateModal').fadeOut(); // Fade out effect when closing the modal
}

$('#shiftDateForm').submit(async function(e) {
    e.preventDefault(); // Prevent the default form submission

    document.getElementById('loading-spinner').style.display = 'block';
    const newDate = $('#newDate').val();
    const newTime = $('#newTime').val();
    const bookingId = window.bookingId; // Use the global bookingId

    // Send the new date and time to the backend to update the booking
    try {
        const response = await fetch('http://localhost:3000/shift-booking-dates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ bookingId, newDate, newTime }),  // Send the booking ID, new date, and time
        });

        if (response.ok) {
            showAlert('Booking dates updated successfully!');
            document.getElementById('loading-spinner').style.display = 'none';
            closeModal(); // Close the modal after successful update
        } else {
            throw new Error('Failed to update booking dates');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error updating booking dates', 'error');
    } finally {
        document.getElementById('loading-spinner').style.display = 'none';
    }
});

// Function to show custom alert
function showAlert(message, type = 'success') {
    const alertBox = document.getElementById('customAlert');
    const alertMessage = document.getElementById('alertMessage');

    // Set the message and type
    alertMessage.textContent = message;
    alertBox.classList.remove('success', 'error');
    alertBox.classList.add(type);

    // Show the alert
    alertBox.style.display = 'block';
    setTimeout(function() {
        alertBox.style.opacity = 1; // Fade in
    }, 10); // Small delay to trigger the fade-in

    // Hide the alert after 3 seconds
    setTimeout(function() {
        alertBox.style.opacity = 0; // Fade out
        setTimeout(function() {
            alertBox.style.display = 'none'; // Hide after fade-out
        }, 500); // Wait for fade-out to finish
    }, 3000); // 3 seconds for the alert to be visible
}


// function showShiftDateModal() {
//     if (typeof $ !== 'undefined') {
//         console.log('jQuery is loaded and ready to use!');
//     } else {
//         console.error('jQuery is not loaded.');
//     }

//     // Your modal code goes here...
// }

// Function to shift booking dates
async function shiftBooking() {
    const newDate = document.getElementById('newDate').value;
    const newTime = document.getElementById('newTime').value;

    if (!newDate || !newTime) {
        alert("Please provide both a new date and time.");
        return;
    }

    try {
        const response = await fetch('http://localhost:3000/shift-booking-dates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ bookingId: bookingToShift, newDate, newTime }),
        });

        if (!response.ok) {
            throw new Error('Failed to shift booking dates');
        }

        alert('Booking dates successfully updated!');
        // Optionally, update the table or status here
        $('#shiftDateModal').modal('hide'); // Close the modal after success
    } catch (error) {
        console.error('Error:', error);
        alert('Error shifting booking dates');
    }
}



// Function to update the status of a booking in the table
function updateBookingStatusInTable(bookingId, newStatus) {
    const rows = document.querySelectorAll('#bookingTable tbody tr');
    rows.forEach(row => {
        const bookingCell = row.cells[0]; // Assuming the booking ID is in the first cell
        if (bookingCell && bookingCell.textContent == bookingId) {
            const statusCell = row.cells[6]; // Assuming the status is in the 7th column
            if (statusCell) {
                statusCell.textContent = newStatus; // Update the status text
            }
        }
    });
}

    
        // Call fetchBookings on page load
        window.onload = fetchBookings;
    </script>
    
</body>
</html>
